# Author A. Loreti, March 2022, cosmic run. andrea.loreti@physics.ox.ac.uk

# Summary: Eval evaluates the quality of the Ladder
# User input: ladder ID 
# Input from MIDAS: DACScan Input/Outputs and IV Input/Outputs
# Output: the total score for the ladder


# SCRIPT /home/labor/online/online/pixels/qctest/ladder/DACScan_test.msl

# PATHS TO MIDAS INPUTs & OUTPUTs
SET path_root, "/Equipment/Mupix/QCTests/Ladder"
CAT path_DAC_input, $path_root,"/DACScan/Input"
CAT path_DAC_output, $path_root,"/ACScan/Output"
CAT path_IV_input, $path_root,"/IV/Input"
CAT path_IV_output, $path_root,"/IV/Output"
CAT path_Eval,$path_root,"/Eval"

# USER INPUT, make new key inside Eval
PARAM ladderID, "Ladder identification number"
CAT Eval_output, $path_Eval,"/",$ladderID
ODBCREATE $Eval_output,INT8,2

# Initialize variables
SET this_current, 0
SET this_V, 0

# Loop index
SET j,0
LOOP i,32
ODBGET $path_IV_output/Current[$j], this_current
ODBGET $path_IV_output/Voltage[$j], this_V

# defines max. current
SET max_current, 0
ODBSUBDIR /Equipment/Mupix/QCTests/Ladder/IV/Input
    ODBGET current_limit, max_current
ENDODBSUBDIR

SET I_thr, $this_current
SET V_thr, $this_V

MESSAGE $j,1
MESSAGE $i,1
MESSAGE $this_current,1
MESSAGE $max_current,1

# We have exceeded max current
IF $this_current>$max_current
GOTO 55
ENDIF

SET j,$i
ENDLOOP

MESSAGE $I_thr,1
MESSAGE $V_thr,1
