# Author J. Guzm√°n, March 2022, Cosmic Run. jose.guzman-funck19@imperial.ac.uk || pepe.guzmanfunck@gmail.com
#
# LV power ON test
# 
# Test description:
#
# TODO
# 1. Add option to change HAMEG channel
# 2. Think about upstream and downstream limitations
# 
# 

# Turn on channel 2 HAMEG
# Loop over pixels. BIASBlock_On to zero all.
# BIASBlock_On to 5 each. Check current difference
# Output current difference on HAMEG channel 2



# Turn on channel 2 of HAMEG
ODBGET /Equipment/HAMEG0/Variables/State[1], now_state_hameg_channel

IF $now_state_hameg_channel == 0
    ODBSET /Equipment/HAMEG0/Variables/Set State[1], 1
ENDIF



# Turn off all
LOOP i, 3
    SET i_, i+2
    CAT path_to_bias, /Equipment/Mupix/Settings/BIASDACS/, $i_, /BiasBlock_On
    ODBSET $path_to_bias, 0
    ODBSET /Equipment/Switching/Settings/MupixChipToConfigure, $i_
    ODBSET /Equipment/Switching/Settings/MupixConfig, 1
ENDLOOP



LOOP i, 3
    # Save init current read
    ODBGET /Equipment/HAMEG0/Variables/Current[1], init_current
    
    # Turn on chip i
    SET i_, $i+2
    CAT path_to_bias, /Equipment/Mupix/Settings/BIASDACS/, $i_, /BiasBlock_On
    ODBSET $path_to_bias, 5
    ODBSET /Equipment/Switching/Settings/MupixChipToConfigure, $i_
    ODBSET /Equipment/Switching/Settings/MupixConfig, 1

    # Read final current
    WAIT SECONDS 1
    ODBGET /Equipment/HAMEG0/Variables/Current[1], current

    # Turn off chip
    ODBSET $path_to_bias, 0
    ODBSET /Equipment/Switching/Settings/MupixChipToConfigure, $i_
    ODBSET /Equipment/Switching/Settings/MupixConfig, 1

    # Save current difference
    SET diff, $current-$init_current
    ODBSET /Equipment/Mupix/QCTests/Ladder/LVPowerOn/Output/current_increase[$i_], $diff
ENDLOOP
