<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="midas.css">
    <script src="controls.js"></script>
    <script src="midas.js"></script>
    <script src="mhttpd.js"></script>
    
    <style>
      :root {
        --grid-cols: 1;
        --grid-rows: 1;
      }

      #hitmap {
        display: grid;
        grid-gap: 1em;
        grid-template-rows: repeat(var(--grid-rows), 1fr);
        grid-template-columns: repeat(var(--grid-cols), 1fr);
      }
      
      #global {
        display: grid;
        grid-gap: 1em;
        grid-template-rows: repeat(var(--grid-rows), 1fr);
        grid-template-columns: repeat(var(--grid-cols), 1fr);
      }

      .grid-item {
        padding: 1em;
        border: 1px solid #ddd;
        text-align: center;
      }
     
    </style>

    <title>OnlineAna</title>
</head>
<body class="mcss" onload="mhttpd_init('myPage');">

<!-- header and side navigation will be filled in mhttpd_start -->
<div id="mheader"></div>
<div id="msidenav"></div>

<div id="mmain">

  <h1>Global DQ Histograms</h1>
  <div id="global"></div>
  
  <h1>Hitmaps</h1>
  startChipID: <input type="text" placeholder="0" id="startID" name="startID">
  <div id="hitmap"></div>
  
  <h1>ChipToChipCor</h1>
  
</div>

<script type='module'>

  import { createHistogram, redraw, httpRequest, draw } from 'https://root.cern/js/latest/modules/main.mjs';

  // create grid container
  function makeRows(rows, cols, id, w, h) {
    const container = document.getElementById(id);
    container.style.setProperty('--grid-rows', rows);
    container.style.setProperty('--grid-cols', cols);
    for (let c = 0; c < (rows * cols); c++) {
      let cell = document.createElement("div");
      cell.id = id+c;
      cell.style.cssText = "width:"+w+"px; height:"+h+"px";
      container.appendChild(cell).className = "grid-item";
    };
  };
  makeRows(2, 5, "hitmap", 250, 150);
  var gHistos = ["chipID", "MIDASEventID", "fpgaID", "hitTime", "hitType"];
  makeRows(1, gHistos.length, "global", 250, 150);
  
  // page settings
  var startID = 0;
  var runNumber = 0;
  var fileName = "";
  function getPageStatus() {
    startID = parseInt(document.getElementById("startID").value);
    
    mjsonrpc_db_get_values(["/runinfo/run number"]).then(function(rpc) {
      runNumber = rpc.result.data[0];
      if (runNumber < 100) {
        fileName = "dataTree000"+runNumber+".root";
      } else if (runNumber < 1000) {;
        fileName = "dataTree00"+runNumber+".root";
      }
    }).catch(function(error) {
      mjsonrpc_error_alert(error);
    });
    
  }

  // get data to plot
  async function updateGUI() {

    getPageStatus();

    // draw global maps
    for (let i = 0; i < gHistos.length; i++) {
//       let gH = await httpRequest('http://localhost:8088/Files/'+fileName+'/HitData/exe.json?method=Draw&prototype="Option_t*"&opt="'+gHistos[i]+'>>h1"&_ret_object_=h1', 'object');
      let gH = await httpRequest('http://localhost:8088/Files/'+fileName+'/'+gHistos[i]+'/root.json', 'object');
      redraw('global'+i, gH, 'hist');
    }
    
    // draw hitmaps
    for (let i = 0; i < 10; i++) {
      let curI = i + startID;
      if (isNaN(curI)) curI = i;
      let colGrow = await httpRequest('http://localhost:8088/Files/'+fileName+'/chip'+curI+'_hitmap/root.json', 'object');
      redraw('hitmap'+i, colGrow, 'colz');
    }
  }
  
  updateGUI();

  setInterval(updateGUI, 3000);
  
</script>
</body>
</html>
