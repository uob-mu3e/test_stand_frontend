#!/bin/bash
set -euf

PREFIX=@CMAKE_INSTALL_PREFIX@
SOURCE=@PROJECT_SOURCE_DIR@
BINDIR=${PREFIX}/bin
BINDIRMIDAS=${SOURCE}/modules/midas/bin
LIBDIR=${PREFIX}/lib

PATH=${BINDIR}:${BINDIRMIDAS}:${PATH}
if [[ "$OSTYPE" == "darwin"* ]]; then
        export DYLD_LIBRARY_PATH="${LIBDIR}${DYLD_LIBRARY_PATH:+:}${DYLD_LIBRARY_PATH}";
fi

export MIDASSYS="${SOURCE}/modules/midas"
export MIDAS_EXPTAB="${SOURCE}/online/exptab"
export MIDAS_EXPT_NAME="Mu3e"
if [ ! -f "${MIDAS_EXPTAB}" ]; then
    echo "${MIDAS_EXPTAB} does not exist, creating default exptab with experiment name ${MIDAS_EXPT_NAME}"
    echo "#Exptname    Expt Directory             Username" >> ${MIDAS_EXPTAB}
    echo "${MIDAS_EXPT_NAME}    ${SOURCE}/online    ${USER}" >> ${MIDAS_EXPTAB}
fi

#Remove duplicates in $PATH
if [ -n "$PATH" ]; then
    old_PATH=$PATH:; PATH=
    while [ -n "$old_PATH" ]; do
        x=${old_PATH%%:*}         # the first remaining entry
        case $PATH: in
            *:"$x":*) ;;          # already there
            *) PATH=$PATH:$x;;    # not there yet
        esac
        old_PATH=${old_PATH#*:}
    done
    PATH=${PATH#:}
    unset old_PATH x
fi

# bash or zsh require a rehash to pick up new commands
if test -n "${BASH}" -o -n "${ZSH_VERSION}"; then
    hash -r
fi
